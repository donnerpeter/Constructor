package cons3

import junit.framework.TestCase

/**
 * @author peter
 */
class SonnetTest extends TestCase {

  public void testParse1() throws Exception {
    doParseTest("Удивительный случай случился со мной: я вдруг забыл, что идет раньше - 7 или 8", """
A.property=AMAZING
A.type=THING
B.type=HAPPEN
B.time=PAST
B.arg1=A
C.type=ME
B.experiencer=C
-- 2:
A.type=ME
B.type=FORGET
B.time=PAST
B.manner=SUDDENLY
B@1.elaboration=B
B.arg1=A
-- 3:
B@2.arg2=A
B.time=PRESENT
A.content=B
A.type=question
A.questioned=C
C.type=wh
B.arg1=C
B.type=COME_SCALARLY
B.order=EARLIER
-- 4:
C@3.variants=A
B.type=7
B.number=true
A.member=B
A.conj=or
A.member=C
C.type=8
C.number=true
""")
  }

  static void doParseTest(String input, String expected) {
    Variable.counter = 0
    Tokens.counter = 0
    def parser = new Parser()
    def chart = parser.parse(input)
    def result = chart.presentable()
    if (expected.trim() != result) {
      println parser.log
      assertEquals expected.trim() + "\n", result + "\n"
    }
  }

  public void testParse2() throws Exception {
    doParseTest "Я отправился к соседям и спросил их, что они думают по этому поводу", """
A.type=ME
B.type=GO_OFF
B.time=PAST
C.type=NEIGHBOURS
B.goal=C
D.type=ASK
D.time=PAST
E.member=B
E.conj=and
E.member=D
B.arg1=A
D.arg1=A
F.type=THEY
D.arg2=F
-- 2:
D@1.question=A
B.type=THEY
C.type=THINK
C.time=PRESENT
C.arg1=B
A.content=C
A.type=question
A.questioned=D
D.type=wh
C.arg2=D
E.determiner=THIS
E.type=MATTER
C.topic=E
"""
  }

  public void testParse3() throws Exception {
    doParseTest "Каково же было их и мое удивление, когда они вдруг обнаружили, что тоже не могут вспомнить порядок счета.", """
A.type=wh
B.type=degree
B.arg1=C
B.arg2=A
B.time=PAST
D.type=THEY
E.member=D
E.conj=and
E.member=F
F.type=ME
C.type=AMAZE
C.arg1=E
-- 2:
A.type=THEY
B.type=DISCOVER
B.time=PAST
B.manner=SUDDENLY
B.arg1=A
B@1.whenCondition=B
-- 3:
B@2.theme=A
B.type=CAN
B.time=PRESENT
B.negated=true
B.also=true
C.type=RECALL
B.theme=C
C.arg2=D
D.type=ORDER
A.type=fact
A.content=B
E.type=COUNTING
D.criterion=E
C.dot=true
"""
  }

  public void testParse3_4() throws Exception {
    doParseTest "Каково же было их и мое удивление, когда они вдруг обнаружили, что тоже не могут вспомнить порядок счета. 1, 2, 3, 4, 5 и 6 помнят, а дальше забыли.", """
A.type=wh
B.type=degree
B.arg1=C
B.arg2=A
B.time=PAST
D.type=THEY
E.member=D
E.conj=and
E.member=F
F.type=ME
C.type=AMAZE
C.arg1=E
-- 2:
A.type=THEY
B.type=DISCOVER
B.time=PAST
B.manner=SUDDENLY
B.arg1=A
B@1.whenCondition=B
-- 3:
B@2.theme=A
B.type=CAN
B.time=PRESENT
B.negated=true
B.also=true
C.type=RECALL
B.theme=C
C.arg2=D
D.type=ORDER
A.type=fact
A.content=B
E.type=COUNTING
D.criterion=E
C.dot=true
-- 4:
A.type=1
A.number=true
-- 5:
A.member=A@4
A.member=B
B.type=2
B.number=true
-- 6:
A@5.member=A
A.type=3
A.number=true
-- 7:
A@5.member=A
A.type=4
A.number=true
-- 8:
A@5.member=A
A.type=5
A.number=true
A@5.conj=and
A@5.member=B
B.type=6
B.number=true
C.type=REMEMBER
C.time=PRESENT
D.rusNumber=pl
D.person=3
C.arg2=A@5
-- 9:
A.andEmphasis=true
A.type=FORGET
A.time=PAST
B.member=C@8
B.conj=but
B.member=A
A.arg2=C
C@8.arg1=D@8
A.arg1=D@8
C.type=NEXT
A.dot=true
"""
  }

  public void testParse5() throws Exception {
    doParseTest 'Мы все пошли в коммерческий магазин "Гастроном", что на углу Знаменской и Бассейной улицы, и спросили кассиршу о нашем недоумении', """
A.type=WE
A.quantifier=ALL
B.type=GO
B.time=PAST
C.kind=COMMERCIAL
C.type=SHOP
B.goal=C
C.name=гастроном
-- 2:
C@1.relative=A
B.relativized=true
A.type=location
A.arg1=B
A.arg2=C
C.type=CORNER
D.type=STREET
D.name=знаменская
C.arg1=E
E.member=D
E.conj=and
E.member=F
F.type=STREET
F.name=бассейная
-- 3:
A.type=ASK
A.time=PAST
B.member=B@1
B.conj=and
B.member=A
B@1.arg1=A@1
A.arg1=A@1
C.type=CASHIER
A.arg2=C
D.type=WE
E.type=PREDICAMENT
E.arg1=D
A.topic=E
"""
  }

  public void testParse6() throws Exception {
    doParseTest "Кассирша грустно улыбнулась, вынула изо рта маленький молоточек и, слегка подвигав носом, сказала:", """
A.type=CASHIER
A.gender=fem
B.type=SMILE
B.time=PAST
B.manner=SADLY
-- 2:
A.type=TAKE_OUT
A.time=PAST
B.member=B@1
B.member=A
B@1.arg1=A@1
A.arg1=A@1
C.type=MOUTH
A.source=C
D.size=LITTLE
D.type=HAMMER
A.arg2=D
-- 3:
A.type=MOVE
A.manner=SLIGHTLY
B.type=NOSE
A.arg2=B
C.perfectBackground=A
-- 4:
C@3.type=SAY
C@3.time=PAST
B@2.conj=and
B@2.member=C@3
C@3.arg1=A@1
C@3.message=A
A.directSpeech=true
"""
  }

  public void testParse7() throws Exception {
    doParseTest "По-моему, семь идет после восьми в том случае, когда восемь идет после семи", """
A.type=OPINION
A.arg1=B
B.type=ME
C.opinion_of=A
-- 2:
A.type=7
C@1.time=PRESENT
C@1.arg1=A
C@1.type=COME_SCALARLY
C@1.order=AFTER
B.type=8
C@1.anchor=B
C.determiner=THAT
C.type=CASE
C@1.condition=C
-- 3:
C@2.whenCondition=A
B.type=8
A.time=PRESENT
A.arg1=B
A.type=COME_SCALARLY
A.order=AFTER
C.type=7
A.anchor=C
"""
  }

  public void testParse6_7() throws Exception {
    doParseTest """Кассирша грустно улыбнулась, вынула изо рта маленький молоточек и, слегка подвигав носом, сказала:
- По-моему, семь идет после восьми в том случае, когда восемь идет после семи""", """
A.type=CASHIER
A.gender=fem
B.type=SMILE
B.time=PAST
B.manner=SADLY
-- 2:
A.type=TAKE_OUT
A.time=PAST
B.member=B@1
B.member=A
B@1.arg1=A@1
A.arg1=A@1
C.type=MOUTH
A.source=C
D.size=LITTLE
D.type=HAMMER
A.arg2=D
-- 3:
A.type=MOVE
A.manner=SLIGHTLY
B.type=NOSE
A.arg2=B
C.perfectBackground=A
-- 4:
C@3.type=SAY
C@3.time=PAST
B@2.conj=and
B@2.member=C@3
C@3.arg1=A@1
C@3.message=A
A.directSpeech=true
-- 5:
A.type=OPINION
A.arg1=B
B.type=ME
A@4.opinion_of=A
-- 6:
A.type=7
A@4.time=PRESENT
A@4.arg1=A
A@4.type=COME_SCALARLY
A@4.order=AFTER
B.type=8
A@4.anchor=B
C.determiner=THAT
C.type=CASE
A@4.condition=C
-- 7:
C@6.whenCondition=A
B.type=8
A.time=PRESENT
A.arg1=B
A.type=COME_SCALARLY
A.order=AFTER
C.type=7
A.anchor=C
"""
  }

  public void testParse8() throws Exception {
    doParseTest """Мы поблагодарили кассиршу и с радостью выбежали из магазина""", """
A.type=WE
B.type=THANK
B.time=PAST
C.type=CASHIER
B.arg2=C
D.type=JOY
E.type=RUN_OUT
E.time=PAST
F.member=B
F.conj=and
F.member=E
B.arg1=A
E.arg1=A
E.mood=D
G.type=SHOP
E.source=G
"""
  }


  public void testTranslate1() throws Exception {
    doTranslateTest "Удивительный случай случился со мной: я вдруг забыл, что идет раньше - 7 или 8",
                    "An amazing thing happened to me today, I suddenly forgot what comes first - 7 or 8"
  }

  public void testTranslate2() throws Exception {
    doTranslateTest "Я отправился к соседям и спросил их, что они думают по этому поводу",
                    "I went to my neighbors and asked them about their opinion on this matter"
  }

  public void testTranslate3() throws Exception {
    doTranslateTest "Каково же было их и мое удивление, когда они вдруг обнаружили, что тоже не могут вспомнить порядок счета.",
                    "Great was their and my amazement, when they suddenly discovered, that they couldn't recall the counting order."
  }

  public void testTranslate4() throws Exception {
    doTranslateTest "1, 2, 3, 4, 5 и 6 помнят, а дальше забыли.",
                    "They remember 1, 2, 3, 4, 5 and 6, but forgot what comes next."
  }

  public void testTranslate3_4() throws Exception {
    doTranslateTest "Каково же было их и мое удивление, когда они вдруг обнаружили, что тоже не могут вспомнить порядок счета. " +
                            "1, 2, 3, 4, 5 и 6 помнят, а дальше забыли.",
                    "Great was their and my amazement, when they suddenly discovered, that they couldn't recall the counting order. " +
                            "They remembered 1, 2, 3, 4, 5 and 6, but forgot what comes next."
  }

  public void testTranslate5() throws Exception {
    doTranslateTest 'Мы все пошли в коммерческий магазин "Гастроном", что на углу Знаменской и Бассейной улицы, и спросили кассиршу о нашем недоумении',
                    "We all went to a commercial grocery store, the one that's on the corner of Znamenskaya and Basseinaya streets to consult a cashier on our predicament"
  }

  public void testTranslate6() throws Exception {
    doTranslateTest 'Кассирша грустно улыбнулась, вынула изо рта маленький молоточек и, слегка подвигав носом, сказала:',
                    "The cashier gave us a sad smile, took a small hammer out of her mouth, and moving her nose slightly back and forth, she said:"
  }

  public void testTranslate7() throws Exception {
    doTranslateTest 'По-моему, семь идет после восьми в том случае, когда восемь идет после семи',
                    "In my opinion, a seven comes after an eight, only if an eight comes after a seven"
  }

  public void testTranslate6_7() throws Exception {
    doTranslateTest '''Кассирша грустно улыбнулась, вынула изо рта маленький молоточек и, слегка подвигав носом, сказала:
- По-моему, семь идет после восьми в том случае, когда восемь идет после семи''',
                    """The cashier gave us a sad smile, took a small hammer out of her mouth, and moving her nose slightly back and forth, she said:
- In my opinion, a seven comes after an eight, only if an eight comes after a seven"""
  }

  public void testTranslate8() throws Exception {
    doTranslateTest 'Мы поблагодарили кассиршу и с радостью выбежали из магазина',
                    "We thanked the cashier and ran cheerfully out of the store"
  }

  public void testParse9() throws Exception {
    doParseTest 'Но тут, вдумываясь в слова кассирши, мы опять приуныли, так как ее слова показались нам лишенными всякого смысла.', '''
A.butEmphasis=true
A.emphasis=true
-- 2:
A.type=THINK
B.type=WORDS
A.theme=B
C.type=CASHIER
B.author=C
A@1.perfectBackground=A
-- 3:
A.type=WE
A@1.type=GET_SAD
A@1.time=PAST
A@1.anchor=AGAIN
A@1.arg1=A
-- 4:
A@1.reason=A
B.type=SHE
C.type=WORDS
C.author=B
A.type=SEEM
A.time=PAST
A.arg1=C
D.type=WE
E.type=LACK
A.theme=E
F.determiner=ANY
F.type=MEANING
E.arg2=F
A.dot=true
'''
  }

  public void testTranslate9() throws Exception {
    doTranslateTest 'Но тут, вдумываясь в слова кассирши, мы опять приуныли, так как ее слова показались нам лишенными всякого смысла.',
            "But there, thinking carefully about cashier's words, we got sad again because her words were void of any meaning."
  }

  public void testParse10() throws Exception {
    doParseTest 'Что нам было делать?', '''
A.type=WE
B.type=DO
C.time=PAST
C.type=modality
C.arg1=B
B.arg1=A
D.type=wh
B.arg2=D
E.content=C
E.type=question
E.questioned=D
'''
  }

  public void testTranslate10() throws Exception {
    doTranslateTest 'Что нам было делать?', 'What were we supposed to do?'
  }

  public void testParse11() throws Exception {
    doParseTest 'Мы пошли в Летний сад и стали там считать деревья', '''
A.type=WE
B.type=GO
B.time=PAST
C.name=Летний сад
C.type=GARDEN
B.goal=C
D.type=BEGIN
D.time=PAST
E.member=B
E.conj=and
E.member=D
B.arg1=A
D.arg1=A
F.type=COUNT
D.theme=F
G.type=TREES
F.arg2=G
'''
  }

  public void testTranslate11() throws Exception {
    doTranslateTest 'Мы пошли в Летний сад и стали там считать деревья',
                    'We went to the Summer Garden and started counting trees'
  }

  public void testParse12() throws Exception {
    doParseTest 'Но дойдя в счете до 6-ти, мы остановились и начали спорить: по мнению одних дальше следовало 7, по мнению других - 8', '''
A.butEmphasis=true
B.type=COME_TO
C.type=COUNTING
B.domain=C
D.type=6
B.goal=D
A.perfectBackground=B
-- 2:
A.type=WE
A@1.type=STOP
A@1.time=PAST
B.type=BEGIN
B.time=PAST
C.member=A@1
C.conj=and
C.member=B
A@1.arg1=A
B.arg1=A
D.type=ARGUE
B.theme=D
-- 3:
A.type=OPINION
B.type=SOME
A.arg1=B
C.time=PAST
C.type=COME_SCALARLY
C.order=AFTER
D@2.elaboration=C
C.opinion_of=A
D.type=7
D.number=true
C.arg1=D
-- 4:
A.type=OPINION
B.type=OTHERS
A.arg1=B
-- 5:
A.type=ellipsis
<A>
B.type=COME_SCALARLY
B.order=AFTER
B.opinion_of=A@4
C.member=C@3
C.conj=but
C.member=B
D@2.elaboration=C
</A>
D.type=8
D.number=true
B.arg1=D
'''
  }

  public void testTranslate12() throws Exception {
    doTranslateTest 'Но дойдя в счете до 6-ти, мы остановились и начали спорить: по мнению одних дальше следовало 7, по мнению других - 8',
                    'But reaching a six in count, we stopped and started arguing: in the opinion of some, a 7 went next; but in opinion of others an 8 did'
  }

  public void testParse13() throws Exception {
    doParseTest "Мы спорили бы очень долго, но, по счастию тут со скамейки свалился какой-то ребенок и сломал себе обе челюсти", """
A.type=WE
B.type=ARGUE
B.time=PAST
B.arg1=A
B.irrealis=true
B.duration=LONG
C.type=LUCK
D.emphasis=true
E.type=BENCH
D.type=FALL
D.time=PAST
F.member=B
F.conj=but
F.member=D
G.rusNumber=sg
G.gender=masc
D.arg1=G
D.source=E
C.topic=D
G.determiner=SOME
G.type=CHILD
H.type=BREAK
H.time=PAST
I.member=D
I.conj=and
I.member=H
J.member=B
J.conj=but
J.member=I
H.arg1=G
K.type=BOTH
H.arg2=L
L.type=JAWS
L.arg1=G
L.quantifier=K
"""
  }

  public void testTranslate13() throws Exception {
    doTranslateTest 'Мы спорили бы очень долго, но, по счастию тут со скамейки свалился какой-то ребенок и сломал себе обе челюсти',
                    'We were arguing for a long time, when by some sheer luck, a child fell off a bench and broke both of his jaws'
  }

  public void testParse14() throws Exception {
    doParseTest 'Это отвлекло нас от нашего спора', '''
A.type=THAT
B.type=DISTRACT
B.time=PAST
B.arg1=A
C.type=WE
B.arg2=C
D.type=WE
E.type=ARGUE
E.arg1=D
B.theme=E
'''
  }

  public void testTranslate14() throws Exception {
    doTranslateTest 'Это отвлекло нас от нашего спора',
            'That distracted us from our argument'
  }

  public void testParse15() throws Exception {
    doParseTest 'А потом мы разошлись по домам', '''
A.type=WE
B.type=DISPERSE
B.time=PAST
B.arg1=A
B.relTime=AFTER
B.andEmphasis=true
C.type=HOMES
B.goal=C
'''
  }

  public void testTranslate15() throws Exception {
    doTranslateTest 'А потом мы разошлись по домам.',
            'And then we all went home.'
  }

  static void doTranslateTest(String input, String expected) {
    Variable.counter = 0
    Tokens.counter = 0
    def parser = new Parser()
    def chart = parser.parse(input)
    String actual
    try {
      actual = new EnglishGenerator().generate(chart)
    } catch (Throwable e) {
      println "\nChart:\n\n${chart.presentable()}"
      println "\nLog:\n\n$parser.log\n"
      throw e
    }
    if (actual != expected) {
      println "\nChart:\n\n${chart.presentable()}"
      println "\nLog:\n\n$parser.log"
    }
    assertEquals expected, actual
  }
}
